<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cinesquare.cinesquare.common.mapper.UserMapper">

    <insert id="signup" parameterType="UserVO">
        /* UserMapper.signup */
        <selectKey keyProperty="cineToken" resultType="String" order="BEFORE">
            SELECT ( CASE WHEN LASTVAL(tb_user_seq) = 999999 THEN 'can_not_insert'
                        WHEN LENGTH(NEXTVAL(tb_user_seq)) = 1 THEN CONCAT('cineuser-00000', NEXTVAL(tb_user_seq))
                        WHEN LENGTH(NEXTVAL(tb_user_seq)) = 2 THEN CONCAT('cineuser-0000', NEXTVAL(tb_user_seq))
                        WHEN LENGTH(NEXTVAL(tb_user_seq)) = 3 THEN CONCAT('cineuser-000', NEXTVAL(tb_user_seq))
                        WHEN LENGTH(NEXTVAL(tb_user_seq)) = 4 THEN CONCAT('cineuser-00', NEXTVAL(tb_user_seq))
                        WHEN LENGTH(NEXTVAL(tb_user_seq)) = 5 THEN CONCAT('cineuser-0', NEXTVAL(tb_user_seq))
                        ELSE CONCAT('cineuser-', NEXTVAL(tb_user_seq))
                        END ) AS cineToken
        </selectKey>
        <if test="cineToken != null and !cineToken.equals( 'can_not_insert' )">
            <if test="apiToken != null and !apiToken.equals('')">
                INSERT INTO tb_user
                VALUES (#{cineToken}, #{apiToken}, #{account}, #{password}, #{name}, 0)
            </if>
        </if>
    </insert>

    <select id="validSignup" parameterType="String" resultType="int">
        /* UserMapper.validSignup */
        SELECT COUNT(cineToken)
        FROM tb_user
        WHERE account = #{param}
    </select>

    <select id="getUserInfo" parameterType="UserVO" resultType="UserVO">
        /* UserMapper.getUserInfo */
        SELECT cineToken
             , apiToken
             , account
             , password
             , name
             , totalWatchTime
        FROM tb_user
        WHERE (account = #{account} AND password = #{password})
           OR (cineToken = #{cineToken} AND apiToken IS NOT NULL)
    </select>

<!--    <insert id="apiSignup" parameterType="UserVO">-->
<!--        /* UserMapper.apiSignup */-->
<!--        INSERT INTO tb_user-->
<!--        VALUES ('cineuser-000011', #{apiToken}, #{account}, #{password}, #{name}, 0)-->
<!--    </insert>-->

<!--    <select id="last" parameterType="UserVO" resultType="String">-->
<!--        /* UserMapper.validAccount */-->
<!--        SELECT cineToken-->
<!--        FROM tb_user-->
<!--        ORDER BY cineToken DESC-->
<!--            LIMIT 1;-->
<!--    </select>-->
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cinesquare.cinesquare.common.mapper.UserMapper">

    <insert id="signup" parameterType="UserVO">
        /* UserMapper.signup */
        <selectKey resultType="String" keyProperty="token" order="BEFORE">
            SELECT (CASE WHEN LENGTH(X.tokenNum) = 1 THEN CONCAT('cineuser-000', X.tokenNum)
                        WHEN LENGTH(X.tokenNum) = 2 THEN CONCAT('cineuser-00', X.tokenNum)
                        WHEN LENGTH(X.tokenNum) = 3 THEN CONCAT('cineuser-0', X.tokenNum)
                        ELSE CONCAT('cineuser-', X.tokenNum)
                    END ) AS token
            FROM (
                SELECT MAX(SUBSTRING(token, 10))+1 AS tokenNum
                FROM tb_user
                WHERE token LIKE 'cineuser-%'
                ) X
        </selectKey>
        INSERT INTO tb_user
        VALUES (#{token}, #{account}, #{password}, #{name})
    </insert>

    <select id="validAccount" parameterType="String" resultType="int">
        /* UserMapper.validAccount */
        SELECT COUNT(token)
        FROM tb_user
        WHERE account = #{param}
    </select>

    <select id="getUser" parameterType="UserVO" resultType="UserVO">
        /* UserMapper.getUser */
        SELECT token
            , account
            , password
            , name
            , totalWatchTime
        FROM tb_user
        WHERE account = #{account}
        AND password = #{password}
    </select>
</mapper>
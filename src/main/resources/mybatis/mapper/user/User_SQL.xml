<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cinesquare.cinesquare.common.mapper.UserMapper">

    <insert id="signup" parameterType="UserVO">
        /* UserMapper.signup */
        <selectKey keyProperty="cineToken" resultType="String" order="BEFORE">
            SELECT ( CASE WHEN LASTVAL(tb_user_seq) = 999999 THEN 'can_not_insert'
                        WHEN LENGTH(NEXTVAL(tb_user_seq)) = 1 THEN CONCAT('cineuser-00000', NEXTVAL(tb_user_seq))
                        WHEN LENGTH(NEXTVAL(tb_user_seq)) = 2 THEN CONCAT('cineuser-0000', NEXTVAL(tb_user_seq))
                        WHEN LENGTH(NEXTVAL(tb_user_seq)) = 3 THEN CONCAT('cineuser-000', NEXTVAL(tb_user_seq))
                        WHEN LENGTH(NEXTVAL(tb_user_seq)) = 4 THEN CONCAT('cineuser-00', NEXTVAL(tb_user_seq))
                        WHEN LENGTH(NEXTVAL(tb_user_seq)) = 5 THEN CONCAT('cineuser-0', NEXTVAL(tb_user_seq))
                        ELSE CONCAT('cineuser-', NEXTVAL(tb_user_seq))
                        END ) AS cineToken
        </selectKey>
        <if test="cineToken != null and !cineToken.equals( 'can_not_insert' )">
            <if test="apiToken != null and !apiToken.equals('')">
                INSERT INTO tb_user
                VALUES (#{cineToken}, #{apiToken}, #{account}, #{password}, #{name}, 0)
            </if>
        </if>
    </insert>

    <select id="validSignup" parameterType="String" resultType="int">
        /* UserMapper.validSignup */
        SELECT COUNT(cineToken)
        FROM tb_user
        WHERE account = #{param}
    </select>

    <select id="getUserInfo" parameterType="UserVO" resultType="UserVO">
        /* UserMapper.getUserInfo */
        SELECT cineToken
             , apiToken
             , account
             , password
             , name
             , totalWatchTime
        FROM tb_user
        WHERE (account = #{account} AND password = #{password})
           OR cineToken = #{cineToken}
    </select>

    <select id="checkMovieGrade" parameterType="GradeReviewVO" resultType="int">
        /* UserMapper.checkMovieGrade */
        SELECT count(grade)
        FROM tb_movie_grade
        WHERE account = #{account}
        AND movieCd = #{movieCd}
    </select>

    <insert id="insertMovieGrade" parameterType="GradeReviewVO">
        /* UserMapper.insertMovieGrade */
        INSERT INTO tb_movie_grade
        VALUES ( #{account}, #{movieCd}, #{grade} )
    </insert>

    <update id="updateMovieGrade" parameterType="GradeReviewVO">
        /* UserMapper.updateMovieGrade */
        UPDATE tb_movie_grade
        SET grade = #{grade}
        WHERE account = #{account}
        AND movieCd = #{movieCd}
    </update>

    <delete id="deleteMovieGrade" parameterType="GradeReviewVO">
        /* UserMapper.deleteMovieGrade */
        DELETE tb_movie_grade
        WHERE account = #{account}
        AND movieCd = #{movieCd}
    </delete>

    <select id="listGradeList" parameterType="UserVO" resultType="Map">
        /* UserMapper.listGradeList */
        SELECT grade, count(grade) AS count
        FROM tb_movie_grade
        WHERE account = #{account}
        GROUP BY grade
    </select>

    <select id="getGradeAndReview" parameterType="GradeReviewVO" resultType="GradeReviewVO">
        /* UserMapper.getGradeAndReview */
        SELECT X.account, X.movieCd, X.grade, Y.review
        FROM tb_movie_grade X
        JOIN tb_movie_review Y
        ON ( X.account = Y.account
            AND X.movieCd = Y.movieCd)
        WHERE X.account = #{account}
            AND X.movieCd = #{movieCd}
    </select>

    <select id="listUserMovieGrade" parameterType="GradeReviewVO" resultType="GradeReviewVO">
        /* UserMapper.listUserMovieGrade */
        SELECT X.grade, Y.movieCd, Y.movieNm
        FROM tb_movie_grade X
        JOIN tb_movie Y
        ON X.movieCd = Y.movieCd
        WHERE X.account = #{account}
    </select>

    <select id="listUserMovieReview" parameterType="GradeReviewVO" resultType="GradeReviewVO">
        /* UserMapper.listUserMovieReview */
        SELECT X.review, Y.movieCd, Y.movieNm
        FROM tb_movie_review X
        JOIN tb_movie Y
        ON X.movieCd = Y.movieCd
        WHERE X.account = #{account}
    </select>
</mapper>